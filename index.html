<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui">
  <meta name="referrer" content="no-referrer">
  <title>播放器</title>
  <style>
    * { box-sizing: border-box; }
    html, body { width: 100%; height: 100%; margin: 0; background: #000; color: #e5e7eb; }
    body { display: flex; align-items: stretch; justify-content: stretch; position: relative; overflow: hidden; }
    #mse { flex: 1; min-height: 0; }
    #status { 
      position: absolute; 
      top: 12px; 
      left: 12px; 
      padding: 8px 12px; 
      background: rgba(0,0,0,0.6); 
      border: 1px solid rgba(255,255,255,0.08); 
      border-radius: 8px; 
      font-size: 13px; 
      color: #cbd5e1; 
      pointer-events: none; 
      /* 新增：默认隐藏元素 */
      display: none; 
      /* 可选：也可用 opacity: 0; transition: opacity 0.2s; 实现渐变隐藏 */
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.byted-static.com/xgplayer/3.0.23/dist/index.min.css">
</head>
<body>
  <div id="mse"></div>
  <div id="status" aria-live="polite"></div>

  <script src="https://unpkg.byted-static.com/xgplayer/3.0.23/dist/index.min.js" charset="utf-8"></script>
  <script src="https://unpkg.byted-static.com/xgplayer-hls/3.0.23/dist/index.min.js" charset="utf-8"></script>
  <script src="https://unpkg.byted-static.com/xgplayer-flv/3.0.23/dist/index.min.js" charset="utf-8"></script>
  <script>
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const streamUrl = (params.get('url') || '').trim();
      const isLive = params.get('isLive') !== 'false';
      const statusEl = document.getElementById('status');

      // 重写 updateStatus 函数：根据文本是否为空控制显示/隐藏
      const updateStatus = text => { 
        if (!statusEl) return;
        statusEl.textContent = text;
        // 有文本则显示，无文本则隐藏
        statusEl.style.display = text ? 'block' : 'none';
        // 若用 opacity 方案：
        // statusEl.style.opacity = text ? '1' : '0';
      };

      if (!streamUrl) {
        updateStatus('缺少播放参数');
        return;
      }

      const detectType = (url, contentType = '') => {
        const lowerUrl = (url || '').toLowerCase();
        const lowerCt = (contentType || '').toLowerCase();
        if (
          lowerUrl.includes('.m3u8') ||
          lowerCt.includes('application/vnd.apple.mpegurl') ||
          lowerCt.includes('application/x-mpegurl')
        ) return 'hls';
        if (
          lowerUrl.includes('.flv') ||
          lowerUrl.startsWith('rtmp://') ||
          lowerCt.includes('video/x-flv')
        ) return 'flv';
        return 'unknown';
      };

      const resolveUrl = async url => {
        try {
          const response = await fetch(url, { method: 'GET', redirect: 'follow' });
          const finalUrl = response.url || url;
          const contentType = response.headers?.get?.('content-type') || '';
          return { url: finalUrl, contentType };
        } catch (error) {
          console.warn('解析地址失败，使用原始地址', error);
          return { url, contentType: '' };
        }
      };

      const buildOptions = (type, url) => {
        const options = {
          id: 'mse',
          isLive,
          playsinline: true,
          url,
          autoplay: true,
          width: '100%',
          height: '100%'
        };

        const plugins = [];

        if (type === 'hls') {
          if(isLive) {
            plugins.push(window.HlsLivePlayer)
          } else {
            plugins.push(window.HlsPlayer);
          }
        } 

        if (type === 'flv') {
          plugins.push(window.FlvPlayer);
        } 

        if (plugins.length) options.plugins = plugins;
        return options;
      };

      const { url: resolvedUrl, contentType } = await resolveUrl(streamUrl);
      const streamType = detectType(resolvedUrl, contentType);
      const options = buildOptions(streamType, resolvedUrl);

      try {
        window.player = new window.Player(options);
        // 初始化成功后，确保隐藏状态提示（防止残留）
        updateStatus('');
      } catch (error) {
        console.warn('初始化 xgplayer 失败', error);
        updateStatus('播放器失败');
      }
    })();
  </script>
</body>
</html>